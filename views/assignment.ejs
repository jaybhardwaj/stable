<html lang="en">
 <% include ./partials/head %>
 <% include ./partials/adminheader %>
 <% include ./partials/setting-header %>

 <style type="text/css">
.class1{
        color:green;
        height:10px;
        margin-left:15px;
}   
.class2{
        color:red;
        height:10px;
        margin-left:15px; 
       }
        .dataTables_filter {
    
    }

 .glyphicon-ok-circle{
  color:green!important;
 }
</style>
<script>
var ch;
var tabledel='';
var rowid=''; 
var stdat=[];
var eddat=[];
var time;

var otable='';
 $(document).ready(function() {


var abc=$("#stat").val();
var ae="AssignmentDate";
var as="AssignmentEndDate";

      
           $('.se-pre-con').fadeOut('slow');
           otable = $("#assigntable").DataTable({

                "ajax": {
                    url: '/assignmentsfordatatable',
                    type: "POST",
                    data: function(d){
                        d.status = $('#stat').val();
                    }
                }, 
"filter": true,
               
                "columns": [
                {"data":"projectTitle"},
                {"data":"WBSCode"},
                {"data":"WBSName"},
                {"data":"firstName"},
                {"data":"AssignmentDate"},
                {"data":"AssignmentEndDate"},
                ],

                "info":false,
                "autoWidth": true,
                "lengthMenu":[[5,10,20,-1],[5,10,20,"All"]],
                 "processing": true,
                 "serverSide": true,

                 "columnDefs": [  

                     {
                       "targets":0,
                       "render":function(data,type,row){

                         var a= "<label>"+row.projectTitle+"</label><input type='hidden' id=usid_"+row.Sno+" value="+row.userId+">";
                         return a;
                         
                         
                     }
                   },
                    {
                       "targets":1,
                       "render":function(data,type,row){

                       
                         var a= "<label>"+row.WBSCode+"</label>";
                         return a;
                                                
                     }
                   }, {
                       "targets":2,
                       "render":function(data,type,row){

                         var a= "<label>"+row.WBSName+"</label>";
                         return a;
                         
                     }
                   }, {
                       "targets":3,
                       "render":function(data,type,row){

                         var a= "<label>"+row.firstName+"</label>";
                         return a;
                         
                     }
                   },
                   {
                      "targets":4,
                       "render":function(data,type,row){

                        var a="<input type='hidden' id=ws_"+row.Sno+" value="+row.wplannedStartDate+"></input><input type='hidden' id=ae_"+row.Sno+" value="+row.AssignmentDate+"></input><input readonly='true' id=i_"+row.id+" class='asdate' style='text-align:center; border:0px' value="+row.AssignmentDate+" onClick='validDate("+row.Sno+","+row.id+")' onChange='updateAssing("+row.AssignmentDate+","+row.id+",1,this,"+row.Sno+")'></input>";
                         return a;
                         
                     }
                   },
                   {
                      "targets":5,
                       "render":function(data,type,row){

                       
                        var a="<input type='hidden' id=we_"+row.Sno+" value="+row.wplannedEndDate+"></input><input type='hidden' id=as_"+row.Sno+" value="+row.AssignmentEndDate+"></input><input  readonly='true' id=j_"+row.id+" class='aedate' style='text-align:center; border:0px' value="+row.AssignmentEndDate+" onClick='validDate("+row.Sno+","+row.id+")'  onChange='updateAssing("+row.AssignmentEndDate+","+row.id+",2,this,"+row.Sno+")'></input>";
                   
                   return a;
                         
                     }
                   },
                   {
                      "targets":6,
                       "render":function(data,type,row){
                        var a;
                          if(row.projectTitle != "DummyProject")
                          {
                                 a="<span onClick='inactive("+row.id+","+row.isActive+")'";
                               if(row.isActive==1)
                                   {
                                  a=a+"class='glyphicon  glyphicon-ok-circle class1'";
                                   } 
                              else
                                    {
                                      a=a+"class='glyphicon  glyphicon-remove-sign class2";
                                    }

                              a=a+"title='Deactivate Assignment'></span>";                         
                         }
                         else
                         {
                          a=""
                         }
                         return a;
                         
                         
                     }

                   }
                    ] 


            });

  
            $('.user-img').addClass('active');

$('#assigntable tbody').on('click', 'tr', function () {
   ch=$(this).children();
   
  this.id="row_"+$(ch[4]).children()[2].id.split('_')[1];
  projectWbsForAssignment($(ch[4]).children()[2].id.split('_')[1]);
  
     } );





$('.se-pre-con').fadeOut('slow');

 projectTable=$('#projectTable').dataTable({
    'iDisplayLength': 10,
    "order":[],
                    "bFilter": false,"bInfo": false,"bLengthChange": false
  });

 wbsTable=$('#wbsTable').dataTable({
    'iDisplayLength': 10,
    "order":[],
                    "bFilter": false,"bInfo": false,"bLengthChange": false
  });

ShowAssignments();
 $('.assignment-img').addClass('active');

         $(".asdate").datetimepicker({
          timepicker:false,
          format:"m/d/y",
          scrollMouse: false,
          scrollInput: false
         });

          $(".aedate").datetimepicker({
            timepicker:false,
            format:"m/d/y",
            scrollMouse: false,
            scrollInput: false
          });
 });


 function formatDate(date) {
                  date1=date.getFullYear();
                 if (date1 < 1970) {
                              date.setFullYear(date1 + 100);
                          } 

                    var d = new Date(date),
                        month = '' + (d.getMonth() + 1),
                        day = '' + d.getDate(),
                        year = d.getFullYear();
                       
                    if (month.length < 2) month = '0' + month;
                    if (day.length < 2) day = '0' + day;

                    return [year, month, day].join('-');
                }




 function validDate(i,id){

                      var date = new Date($('#ws_'+i).val());
                      var date1 = new Date($('#we_'+i).val());

      var date = formatDate(date);
                            var date1 = formatDate(date1);
                            var date=new Date(date);
                            var date1=new Date(date1);

                       $("#i_"+id).datetimepicker({ 
                                                          timepicker:false,
                                                          format:"m/d/y",
                                                           minDate: date,
                                                          maxDate: date1 ,
                                                          scrollMouse: false,
                                                          scrollInput: false});

                      $("#j_"+id).datetimepicker({     timepicker:false,
                                                       format:"m/d/y",
                                                       minDate: date,
                                                       maxDate: date1,
                                                       scrollMouse: false,
                                                       scrollInput: false  });
 }
function updateAssing(ldate,id,a,date,i){  

   if(a==1)
    {  
        checkTimeSheetDate(i,a);       
         setTimeout(function(){
          if(time)
          { 
               alert("You can not edit Assignment Start Date as User has been filled Timesheet for this FortNight");
                $('#i_'+id).val($('#ae_'+i).val());
               return false;
          }
        },300);        
          var dt="AssignmentDate";
          if(new Date($('#j_'+id).val())<new Date(date.value))
          {
          alert("Assignment start date sholud not greater than Assignment End Date");
          $('#i_'+id).val($('#ae_'+i).val()); 
          return false;
          }
    }
     else
    { 
          checkTimeSheetDate(i,a);
         
           setTimeout(function(){
         if(time)
           {  
             if(new Date($('#as_'+i).val())>new Date(date.value))
             {
             $('#j_'+id).val($('#as_'+i).val());
             alert("You can not select previous date as Timesheet has been filled for that FortNight");
             }
           }
         },300);
           
           var dt="AssignmentEndDate";
           if(new Date($('#i_'+id).val())> new Date(date.value))
           {
           alert("Assignment End Date should not lesser than Assignment Start Date");
           $('#j_'+id).val($('#as_'+i).val());
          return false;
           }  
   }
     $.ajax({   
                    url:'/submitAssignment',
                    type:'post',
                    data:{
                      "flag":a,
                      "assignmentId":id,
                      "procode":'1',
                      "wbs":'1',
                      "user":'1',
                      "status":'1',
                      "asdate":date.value,
                      "aedate":date.value,
                        "curdat":'',
                      "retailerid":''
                    },

                  success:function(data){
                      $(".active-row").click();
             
                 }
                  });
     
}

function checkTimeSheetDate(i,b){
  if(b==1)
{var a=new Date($('#ae_'+i).val());
}
else
{
var a=new Date($('#as_'+i).val());
}
var a1=a.getDate();
var a2=a.getMonth();
var a3=a.getFullYear();
if(a1<=15){                     
                        checkdate = a3+'-'+(a2+1)+'-'+15;
          }
    else{
      checkdate = a3+'-'+(a2+1)+'-'+new Date(a3,(a2+1),0).getDate();
        }
         userId=$('#usid_'+i).val();   
                $.ajax({
                    url: 'checkUserTimesheet',
                    type: 'post',
                    data: {
                        "userId": userId,
                        "tdate": checkdate
                    },
                    success: function(data)
                                         {
                                            if(data[0].length!=0)
                                                    {time=1;
                                                    }
                                                        else
                                                          time=0;
                                          }                          
                });           
}

function ShowAssignments(){  


  otable.ajax.reload();

         $(".asdate").datetimepicker({
          timepicker:false,
          format:"m/d/y",
                                    scrollMouse: false,
                                    scrollInput: false
         });
         
          $(".aedate").datetimepicker({
            timepicker:false,
            format:"m/d/y",
                                    scrollMouse: false,
                                    scrollInput: false
          });

 
  var a='';
 
                $('#acttab').html(a);
            
       }
function inactive(b,flag){;
  if(flag==1)
    var a="deactivate";
    else
    var a="activate";
    
if(confirm("Do you want "+a+" this assignment?"))
window.location.href = "/changeAssignmentStatus?assignmentId="+b+"& flag="+1;


}

function projectWbsForAssignment(aid){
   $('#assigntable').dataTable().$("tr").addClass('hide');
 
  $('#assigntable').dataTable().$("tr").removeClass('active-row');
 
  
            
         
            $("#row_"+aid).addClass('active-row');
           
            $(".active-row").removeClass('hide');

$('#projectDiv').removeClass('hide');

$('#wbsDiv').removeClass('hide');

  $.ajax({
                url: '/projectWbsForAssignment',
                type: 'post',
                data: { "aid":aid },
                success: function(data) {

                  var log='',log1='';
                  var sdate='',edate='';
                   for (var i = 0; i < data[0].length ; i++) {

                      if(data[0][i].actualStartDate=='00/00/00'){data[0][i].actualStartDate='';}
                      if(data[0][i].actualEndDate=='00/00/00'){data[0][i].actualEndDate='';}


                      log=log+ '<tr style=height:20px;color:grey;font-size:12px; class="rows1" onclick="highlight('+data[0][i].id+',0,1)" id="projectRow_'+data[0][i].id+'"><td><input type="text"  style="cursor: pointer;border:0px"   readonly="true"  value="'+data[0][i].projectTitle+'" id="pname_'+data[0][i].id+'" onchange="changeProjectWbs('+data[0][i].id+',0,2);"></td><td><input type="text"  style="cursor: pointer;border:0px"   readonly="true"  id="psdate_'+data[0][i].id+'" value="'+data[0][i].plannedStartDate+'" onchange="changeProjectWbs('+data[0][i].id+',0,2);"></td><td><input type="text"  style="cursor: pointer;border:0px"   readonly="true" id="pedate_'+data[0][i].id+'" value="'+data[0][i].plannedEndDate+'" onchange="changeProjectWbs('+data[0][i].id+',0,2);"></td></tr>';

                      $('body').on('focus',"#psdate_"+data[0][i].id, function(){
                          $(this).datetimepicker({
                                timepicker:false,
                                format:"m/d/y",
                                    scrollMouse: false,
                                    scrollInput: false
                               });
                      });
                      $('body').on('focus',"#pedate_"+data[0][i].id, function(){
                          $(this).datetimepicker({
                                timepicker:false,
                                format:"m/d/y",
                                    scrollMouse: false,
                                    scrollInput: false
                               });
                      });

                   }


                   projectTable.fnDestroy();
                    $('#projectBody').html(log);
                    projectTable=$('#projectTable').dataTable({
                      'iDisplayLength': 10,
                      "order":[],
                    "bFilter": false,"bInfo": false,"bLengthChange": false
                      });


                    for (var i = 0; i < data[1].length ; i++) {
                      sdate=data[1][i].plannedStartDate;
                      edate=data[1][i].plannedEndDate;

                      var date = new Date(sdate);
                            var date1 = new Date(edate);

                            var date = formatDate(date);
                            var date1 = formatDate(date1);
                            var date=new Date(date);
                            var date1=new Date(date1);

                            if(data[1][i].wactualStartDate=='00/00/00'){data[1][i].wactualStartDate='';}
                      if(data[1][i].wactualEndDate=='00/00/00'){data[1][i].wactualEndDate='';}

                       log1 = log1 + '<tr  id="wbsrow_'+data[1][i].WBSId+'" class="rows2" onclick="highlight(0,'+data[1][i].WBSId+',2)"   style=height:20px;color:grey;font-size:12px ><td><input type="text"  style="cursor: pointer;border:0px"  readonly="true"  id="wbsname_'+data[1][i].WBSId+'" value="' + data[1][i].WBSName + '" onchange="changeProjectWbs(0,'+data[1][i].WBSId+',3)"></td><td><input type="text"  style="cursor: pointer;border:0px"  readonly="true" style="border:0px" class="wpsdate" id="wpsdate_'+data[1][i].WBSId+'"  value="' + data[1][i].wplannedStartDate + '" onchange="changeProjectWbs(0,'+data[1][i].WBSId+',3)"></td><td><input type="text" style="cursor: pointer;border:0px"    class="wpedate"  readonly="true"  id="wpedate_'+data[1][i].WBSId+'" style="border:0px" value="' + data[1][i].wplannedEndDate + '" onchange="changeProjectWbs(0,'+data[1][i].WBSId+',3)"></td><td><input type="text"  style="cursor: pointer;border:0px"  id="wasdate_'+data[1][i].WBSId+'"  readonly="true"  class="wasdate"  style="border:0px"  value="' + data[1][i].wactualStartDate + '" onchange="changeProjectWbs(0,'+data[1][i].WBSId+',3)"></td><td><input type="text" style="cursor: pointer;border:0px"   id="waedate_'+data[1][i].WBSId+'" class="waedate"  readonly="true"   style="border:0px"  value="' + data[1][i].wactualEndDate + '" onchange="changeProjectWbs(0,'+data[1][i].WBSId+',3)"></td></tr>';

                        $('body').on('focus',"#wpsdate_"+data[1][i].WBSId, function(){
                            $(this).datetimepicker({
                                    timepicker: false,
                                    minDate: date,
                                    maxDate: date1,
                                    format: 'm/d/y',
                                    scrollMouse: false,
                                    scrollInput: false
                                 });
                        });
                        $('body').on('focus',"#wpedate_"+data[1][i].WBSId, function(){
                            $(this).datetimepicker({
                                    timepicker: false,
                                    minDate: date,
                                    maxDate: date1,
                                    format: 'm/d/y',
                                    scrollMouse: false,
                                    scrollInput: false
                                 });
                        });
                        $('body').on('focus',"#wasdate_"+data[1][i].WBSId, function(){
                            $(this).datetimepicker({
                                  timepicker:false,
                                  format:"m/d/y",
                                    scrollMouse: false,
                                    scrollInput: false
                                 });
                        });
                        $('body').on('focus',"#waedate_"+data[1][i].WBSId, function(){
                            $(this).datetimepicker({
                                  timepicker:false,
                                  format:"m/d/y",
                                    scrollMouse: false,
                                    scrollInput: false
                                 });
                        });
                             


                   }


                   wbsTable.fnDestroy();
                    $('#wbsBody').html(log1);
                    wbsTable=$('#wbsTable').dataTable({
                      'iDisplayLength': 10,
                      "order":[],
                    "bFilter": false,"bInfo": false,"bLengthChange": false
                      });

                   
                }

            });
}

function highlight(pid,wbsid,flag){
  if(flag==1){
    $(".rows1").removeClass('active-row');
            $("#projectRow_"+pid).addClass('active-row');
  }
  else{
    $(".rows2").removeClass('active-row');
            $("#wbsrow_"+wbsid).addClass('active-row');
  }
}



 function checkProject(projectId){
  var pname=$('#pname_'+projectId).val();
    var psdate=$('#psdate_'+projectId).val();
    var pedate=$('#pedate_'+projectId).val();
    var asdate=$('#asdate_'+projectId).val();
    var aedate=$('#aedate_'+projectId).val();

    var sdate = new Date(psdate);
                var edate = new Date(pedate);
                var pasdate = new Date(asdate);
                var paedate = new Date(aedate);
              

                if (sdate > edate) {
                    alert('Planned End Date can not be less than Planned Start Date');
                    return false;
                }

                if (paedate != '') {
                    if (pasdate != '') {
                        if (asdate > aedate) {
                            alert('Actual End Date can not be less than Actual Start Date');
                            return false;
                        }
                    } else {
                        alert('Please Select Actual Start Date');
                        return false;
                    }
                }

                return true;
 }


 function checkWBS(wbsid){
                wbsname=$('#wbsname_'+wbsid).val();
               wpsdate=$('#wpsdate_'+wbsid).val();
               wpedate=$('#wpedate_'+wbsid).val();
                wasdate=$('#wasdate_'+wbsid).val();
                waedate=$('#waedate_'+wbsid).val();
                var sdate = new Date(wpsdate);
                var edate = new Date(wpedate);
                var asdate = new Date(wasdate);
                var aedate = new Date(waedate);

              

                if (sdate > edate) {
                    alert('Planned End Date can not be less than Planned Start Date');
                    return false;
                }

                if (waedate != '') {
                    if (wasdate != '') {
                        if (asdate > aedate) {
                            alert('Actual End Date can not be less than Actual Start Date');
                            return false;
                        }
                    } else {
                        alert('Please Select Actual Start Date');
                        return false;
                    }
                }

                return true;
 }




function changeProjectWbs(pid,wid,flag){

  var a=checkWBS(wid);
  var b=checkProject(pid);


  if(flag==2){
    if(b==true){
    var pname=$('#pname_'+pid).val();
    var psdate=$('#psdate_'+pid).val();
    var pedate=$('#pedate_'+pid).val();
    var asdate=$('#asdate_'+pid).val();
    var aedate=$('#aedate_'+pid).val();



    $.ajax({
                url: '/changeProjectWbs',
                type: 'post',
                data: { "pid":pid,"pname":pname,"psdate":psdate,"pedate":pedate,"asdate":"0","aedate":"0","wid":0, "wbsname": "0","wpsdate":"0" ,"wpedate":"0", "wasdate":"0","waedate":"0","flag":flag},
                success: function(data) {
                 
                   if(data[0][0].msg==1){
                        alert('Date validations of Project are not according to WBS');
                    }

                    ShowAssignments();
                  


                }

            });
     }
  }
  else{
    if(a==true){
    wbsname=$('#wbsname_'+wid).val();
   wpsdate=$('#wpsdate_'+wid).val();
   wpedate=$('#wpedate_'+wid).val();
    wasdate=$('#wasdate_'+wid).val();
    waedate=$('#waedate_'+wid).val();


    $.ajax({
                url: '/changeProjectWbs',
                type: 'post',
                data: { "pid":0,"pname":"0","psdate":"0","pedate":"0","asdate":"0","aedate":"0","wid":wid, "wbsname": wbsname,"wpsdate":wpsdate ,"wpedate":wpedate, "wasdate":wasdate,"waedate":waedate,"flag":flag },
                success: function(data) {
                   $(".active-row").click();


                   if(data[0][0].msg==2){
                        alert('Date validations of WBS are not according to Assignment');
                    }

                   

                   
                }

            });
       }
  }
}

</script>

 
    <script>
   function exportAssignment(type)
{
  var status=$("#stat").val();
     $(".se-pre-con").fadeIn("slow");
var header=['Project Name','WBS Code','WBS Name','User Name','Assignment Start Date','Assignment End Date','Status'];

var url = window.location.origin.split("/")[3] ? window.location.origin : window.location.origin + '/exportToCsv';
$.ajax({
url: url,
method: 'POST',
data : {"type":type,'status':status},
success: function(data) {
data.unshift(header);
alasql("SELECT * INTO CSV('Assignment.csv') FROM ?",[data]);

},
dataType: 'JSON',
});   

$(".se-pre-con").fadeOut("slow");
}

function showAll()
{
    $('#assigntable').dataTable().$('tr').removeClass('hide');
    }



</script>



<div class="se-pre-con"></div>


    <div class="secondry-color" style="padding-bottom:2%;padding-left :2%;padding-right:2%;  "> 
    
      
<div class="row" style="padding-top:1%;max-width: 103%">
    <a href="createassignment?flag=0&assignmentId=0">
    <img  title="Create New"   class="addNewPlus"></a>
     <span class="modal-title" style="padding-left:35%"> Assignments</span>

   
<span style="margin-left:10px" class="glyphicon glyphicon-fullscreen" onclick="showAll()" title="Show All" ></span>
 <select  id="stat" class="form-text-box" style="float:left;width:auto; margin-bottom:1%;margin-left:10px;margin-top: 3px" onChange="ShowAssignments()"> 
        <option value='1'>    Active         </option>
        <option value='0'>    InActive    </option>
        <option value='2'  >   All           </option>
      </select>

      <span id="download" class="glyphicon glyphicon-download" onclick="exportAssignment('assignment')" style="margin-left:315px;cursor: pointer;font-size:19px" title="Download Assignments List" ></span>


  </div>
   <div  class="row table-responsive" style="max-width:103%;overflow-y:auto "> 


      <table   id="assigntable" class=" table stripe hover cell-border">  
                 <thead>
                    <tr >
                        <th >Project Name</th>
                        <th >WBS Code</th>
                        <th >WBS Name</th>
                        <th >User Name</th>
                        <th >Assignment Start Date</th>
                        <th >Assignment End Date</th>
                        <th >Action</th>
                    </tr>
                </thead>                
                <tbody id="acttab">
              </tbody>
              </table>
    </div>




    <div id="projectDiv" class="hide row" style="padding-bottom:2%;padding-left :0%;padding-right:0%; max-width:103%;overflow-y:auto  ">

    <div style="margin-bottom:10px;margin-top:10px;">
          <span class="modal-title" style="padding-left:45%;margin-top:10px">Project for selected assignment</span>
          </div>

<div class="table-responsive">
            <table class="table stripe cell-border hover" id="projectTable"  >

               <thead>
                
                 <tr  >
                
                <th   >Project title</th>
                <th   >Planned Start Date</th>
                <th   >Planned End Date</th>  
                </tr>
               </thead>
                  
               <tbody id="projectBody">
                
              </tbody>
            </table>
          </div>
          </div>

          <div id="wbsDiv" class="hide row" style="padding-bottom:2%;padding-left :0%;padding-right:0%; max-width:103%;overflow-y:auto">

           <div style="margin-bottom:10px">
          <span class="modal-title" style="padding-left:45%;margin-top:10px">WBS for selected assignment</span>
          </div>
          <div class="table-responsive">
              <table class="table stripe cell-border hover" id="wbsTable"  > 
                   <thead> 
                    <th   >WBS Name</th>
                <th   >Planned Start Date</th>
                <th   >Planned End Date</th>
                <th   >Actual Start Date</th>
                <th   >Actual End Date</th> 
                      </thead>
                      
                   <tbody id="wbsBody">
                    
                  </tbody>
                </table>
              </div>
            </div>
            </div>
   
     </div>

   </div>
   
  <div>  
    <% include ./partials/footer %>     </div>