<% include ../partials/head %>  
    <% include ../partials/adminheader %>

<title>All Requisition</title>

 <style>
          .dataTables_filter {
                        display: none;
                    }
                    label{
                        font-size: 12px;
                        color:black;
                    }
                   
          .detailLabelTitle {
                background-color: none;
                color: black;
                font-size: 14px;
                font-weight: 2px;
            }
   
            .detailLabelContent {
                background-color: none;
                color: grey;
                font-size: 12px;
                text-align: center;
            }
           
            </style>

    <body>
        <%include menu1.ejs%>
        <div class="secondry-color"> 
          <label class="fusion-page-title"> Requisitions </label>
        
        <div class="row fusion-table-container">
            <div class="row fusion-table-top-section" align="center">
                <div>
                   <select class="form-control input-sm action hide" style="width:150px" id="selectAdminHr">
                 
                    <%for(var i = 0 ;i<adminhr.length;i++){%>
                        <option value="<%=adminhr[i].id%>" id="adminhr_<%=adminhr[i].id%>">
                            <%=adminhr[i].firstName%>
                        </option>
                        <%}%>
                            <option value="-1" id = 'allid'>All</option>
                    </select>
                </div>
                <div class="fusion-table-search-container">
                    <label>Search: </label><input type="search" class="form-control input-sm fusion-table-search" id="searchbox">
                </div>
              
            </div>
            <div class="table-responsive">
            <table id="openreqstate1" class="table cell-border responsive" style="font-size:13px;width:100%">
                <thead>
                    <tr>
                        <th >Title</th>
                        <th>Skills</th>
                        <th># Positions</th>
                        <th>Experience</th>
                        <th>Raised By</th>
                        <th class="hide">Status</th>
                        <th>Recruiter</th>
                        <th>Manager HR</th>                        
                        <th class="action hide">Assign Recruiter</th>
                        <th class='hide'></th>
                    </tr>
                </thead>
                <tbody id="tbodyReq">
                
                </tbody>
            </table>
        </div>
        </div> 
</div>


<% include ../partials/footer %> 


         <script type="text/javascript">
 var hrRole=<%-JSON.stringify(role)%>;
 var roleArr=[];
 for(var i=0;i<hrRole.length;i++){
    roleArr.push(hrRole[i].hrRoleId)
 } 
       $(".close").click(function(){
        $('#jddetail').modal("hide");
});
 
        function reqData(id, flag, con) {
                        $.ajax({
                        url: '/reqData',
                        data: {
                            'id': id
                        },
                        method: 'post',
                        success: function(data) {

                                var flage = flag;
                                var ide = id;
                                var cities = JSON.parse(JSON.stringify(data.result[0]));
                                var skill = JSON.parse(JSON.stringify(data.result[1]));
                                var admin = JSON.parse(JSON.stringify(data.result[2]));
                                var desig = JSON.parse(JSON.stringify(data.result[3]));
                                var info = JSON.parse(JSON.stringify(data.result[5]));
                                var dviewinfo = JSON.parse(JSON.stringify(data.result[9]));
                                var prio = JSON.parse(JSON.stringify(data.result[4]));
                                var arstr = []; 
                                 if (con == 7) {
                                    $('#ModalHeading').html("Requisition Details");
                                  
                                    $('#djobTitle').html(dviewinfo[0].title);
                                    $('#dnoOfPositions').html(dviewinfo[0].positions);
                                    $('#dminsal').html(dviewinfo[0].minimumSalary);
                                    $('#dmaxsal').html(dviewinfo[0].maximumSalary);
                                    $('#drec').html(dviewinfo[0].recruiter);
                                    $('#dexpiresOn').html(dviewinfo[0].expireDate);
                                    $('#dyox').html(dviewinfo[0].Experience)
                                    $("#ddesig").html(dviewinfo[0].designation);
                                    $('#dpriority').html(dviewinfo[0].priority);
                                    $("#dlocation").html(dviewinfo[0].location);
                                    $("#djobType").html(dviewinfo[0].type);
                                    $("#dadminhr").html(dviewinfo[0].adminHr);

                                    var arr = [];
                                    for (var i = 0; i < JSON.parse(JSON.stringify(data.result[6])).length; i++) {
                                        arr[i] = JSON.parse(JSON.stringify(data.result[6]))[i].skillName;
                                    }
                                    $('#dskillsId').html(arr.toString());
                                    $("#ddiscription").html(dviewinfo[0].description);
                                    $('#dhistoryTable').html('');
                                    var counter = 1;
                                    var cname;
                                    var desc;
                                    
                                    for (var i = 0; i < data.result[8].length; i++) {
                                        desc = data.result[8][i].description;
                                        $('#dhistoryTable').append("<tr style=padding-top:2%;width:100%;float:left;font-size:14px;color:grey><td style=color:black>" + counter++ + ".</td><td>\t" + data.result[8][i].name + " has edited <b style=color:black>" + data.result[8][i].columnName + "</b> to " + desc + " on <b>" + data.result[8][i].date.slice(0, 10) + "</b> </td></tr></br>");
                                    }
                                }
                            }
                        });
                    }





                    var uid = <%=uid%>;
                    var reqId, rownumber;
                    var newDataTable;
                    $('#openreqstate1').on('click', 'img.icon-delete', function() {
                        table
                            .row($(this).parents('tr'))
                            .remove()
                            .draw();
                    });
                    var descriptionarray = [];
                    var plength = <%=pdetails.length%>;
                    $(document).ready(function() {
                        $('.viewReq-img').addClass("active");
                 
                        var adminstr = '#adminhr_' + uid;
                           $('#noid').attr("selected", "selected");
                          $('#allid').attr("selected", "selected"); 
                              setTimeout(function(){   $('#selectAdminHr').change(); }, 500);  

                        for (var k = 0; k < plength; k++) {
                            var str = '#desc_' + k;
                            var decode = $(str).text();
                            $(str).html(decode);
                        }
                        for (var k = 0; k < plength; k++) {
                            var str = '#con_' + k;
                            if ($(str).html() == null || $(str).html() == '') {
                                $(str).html('<i class="glyphicon glyphicon-remove" style = "color:red"  title = "Unassigned"></i>');
                            } else {
                                $(str).html('<i class="glyphicon glyphicon-ok" style = "color:green" title = "Assigned"></i>');
                            }

                        }
                        newDataTable = $("#openreqstate1").dataTable({ 
                            "bFilter": true,
                            "pageLength": 10,
                            "bLengthChange": false,
                            "columnDefs": [
							    { "width": "40%", "targets": 1 }
							  ]
                        });
                           $("#searchbox").keyup(function() {
                        newDataTable.fnFilter(this.value);
                    }); 


                        $('#selectAdminHr').change(function() {
                           
                            var ch = '';
                            var selected = $('#selectAdminHr').val();
                            selected = parseInt(selected);
                            if (isNaN(selected) || selected == -2) return false;
                            $.ajax({
                                url: 'selectAdminHr',
                                data: {
                                    'selected': selected
                                },
                                method: 'post',
                                success: function(pdetails) {
                                    if(newDataTable != null)newDataTable.fnDestroy();
                                    $('#tbodyReq').html(''); 

                if((roleArr.indexOf(1)>=0&&roleArr.indexOf(2)>=0)|| roleArr.indexOf(1)>=0){
                    $(".action").removeClass("hide");
                                    for (var i = 0; i < pdetails.length; i++) {
                                        var hide = 'hide'; 
                                        if (pdetails[i].adminHr == uid) {
                                            hide = '';
                                        }

                                        ch = ch+'<tr id = "row_'+pdetails[i].id + '"><td style = "width:40%"><a onclick=reqData('+ pdetails[i].id +',"show",7) data-toggle="modal" data-target="#jdDetailModal" style="color:black;cursor:pointer">' + pdetails[i].title + '</a></td><td>' + pdetails[i].skills + '</td><td style = "width:10%">' + pdetails[i].positions + '</td><td style = "width:10%">' + pdetails[i].Experience + '</td><td>'+pdetails[i].createdByName+'</td><td class="hide" id = "con_' + i + '">' + pdetails[i].assignedTo + '</td>';
                                        if(pdetails[i].assignedTofirstName!=null){
                                       ch=ch+ '<td id = "assign_' + pdetails[i].id + '">' + pdetails[i].assignedTofirstName + '</td>';}
                                       else{
                                        ch=ch+'<td id = "assign_' + pdetails[i].id + '"><span class="fa fa-ellipsis-h"></span></td>';
                                       }
                                       hrUser="<%for(var i = 0 ;i<userInfo.length;i++){%><option value='<%=userInfo[i].id%>' <%if(userInfo[i].id=="+pdetails[i].assignedTo+"){selected}%> id='option_<%=userInfo[i].id%>'><%=userInfo[i].firstName%></option><%}%>"
                                       ch=ch+'<td>' + pdetails[i].adminHrfirstName + '</td><td ><select class="' + hide + '"  id = "edit_' + pdetails[i].id+'_'+i+'" onchange="saveRecruter(this.id,'+pdetails[i].id+')"><option value="0">select</option>'+hrUser+'</select></td><td class = "hide" id = "user_' + pdetails[i].id + '">' + pdetails[i].assignedTo + '</td></tr>';
                                    }
                                }
                                else{
                                     for (var i = 0; i < pdetails.length; i++) {
                                        if(pdetails[i].assignedTo==uid){
                                        var hide = 'hide'; 
                                        if (pdetails[i].adminHr == uid) {
                                            hide = '';
                                        }

                                        ch = ch+'<tr id = "row_'+pdetails[i].id + '"><td style = "width:40%"><a onclick=reqData('+ pdetails[i].id +',"show",7) data-toggle="modal" data-target="#jdDetailModal" style="color:black;cursor:pointer">' + pdetails[i].title + '</a></td><td>' + pdetails[i].skills + '</td><td style = "width:10%">' + pdetails[i].positions + '</td><td style = "width:10%">' + pdetails[i].Experience + '</td><td>'+pdetails[i].createdByName+'</td><td class="hide" id = "con_' + i + '">' + pdetails[i].assignedTo + '</td>';
                                        if(pdetails[i].assignedTofirstName!=null){
                                       ch=ch+ '<td id = "assign_' + pdetails[i].id + '">' + pdetails[i].assignedTofirstName + '</td>';}
                                       else{
                                        ch=ch+'<td id = "assign_' + pdetails[i].id + '"><span class="fa fa-ellipsis-h"></span></td>';
                                       }
                                      
                                       ch=ch+'<td>' + pdetails[i].adminHrfirstName + '</td> </tr>';
                                   }
                                }
                            }


                                    $('#tbodyReq').html(ch);
                                    for (var k = 0; k < pdetails.length; k++) {
                                        var str = '#con_' + k;
                                        var str2 = '#assign_' + k;

                                        if ($(str).html() == null || $(str).html() == '' || $(str).html() == 'null') {

                                            $(str).html('<i class="glyphicon glyphicon-remove" style = "color:red"  title = "Unassigned"></i>');
                                        } else {
                                            $(str).html('<i class="glyphicon glyphicon-ok" style = "color:green" title = "Assigned"></i>');
                                        }
                                    }
 $("#openreqstate1").dataTable({ 
                            "bFilter": true,
                            "pageLength": 10,
                            "bLengthChange": false
                        });
                           $("#searchbox").keyup(function() {
                        newDataTable.fnFilter(this.value);
                    });

                     
                                }
                            });

                        });
                    });

                

                    function saveRecruter(id,reqId) {
                        var selected = parseInt($('#'+id).val());

                        if (selected == 0) return;
                      
                        $.ajax({

                            url: 'savehrm',
                            data: {
                                'selected': selected,
                                'reqId': reqId
                            },
                            method: 'post',
                            success: function() {
                                var str = '#assign_' + reqId; 
                                   alert('Requisition assigned'); 
                                var str2 = '#option_' + selected; 
                                $(str).html($(str2).html());
                           
                                var str4 = '#user_' + reqId;
                                $(str4).html(selected); 
                            }
                        });




                    }
                </script>
                <style type="text/css">
             
                    
                    #main-menu {
                        margin-top: 5.6% !important;
                        height: 81.2% !important;
                    }
                    
                    table {
                        text-align: center;
                    }
                    
                    thead th {
                        text-align: center;
                    }
                </style>
        
    </body>


    <style>

    .dataTables_filter {
     display: none;
    }

       /* thead th {
            text-align: center;
            background-color: #7FCEE6;
            color: #4D4E50;
        }*/

          .detailLabelTitle {
            background-color: none;
            color: #f05f40;
            font-size: 14px;
            font-weight: 2px;
        }
        
        .detailLabelContent {
            background-color: none;
            color: black;
            font-size: 12px;
            text-align: center;
        }
    </style>

    
      <div class="modal fade" id="jdDetailModal" role="dialog">
            <div class="modal-dialog modal-lg" style="">
                <div class="modal-content" style=" ">
                    <div class="modal-header"  >
                        <button type="button" class="close" data-dismiss="modal" style="margin-top:-10px">&times;</button>
                        <center>
                            <h4 id="dModalHeading" class="modal-title"  style="color:white">Requisition Details</h4></center>
                    </div>
                    <div class="modal-body table-responsive" style="">

                    <table style="" class="table">
                        <tr>
                            <td>
                                <td><label class="form-Label">Job Title :</label></td>
                                <td><label class="detailLabelContent" style=" " id="djobTitle"></label></td>
                            </td>
                            <td>
                                <td><label class="form-Label">Designation :</label></td>
                                <td><label class="detailLabelContent" style=" " id="ddesig"></label></td>
                            </td>
                        </tr>
                         <tr>
                            <td>
                                <td>    <label class="form-Label">Location :</label> </td>
                                <td>
                                    <label class="detailLabelContent" style=" " id="dlocation"></label> </td>
                            </td>
                            <td>
                                <td><label class="form-Label">Skills :</label> </td>
                                <td> 
                                    <span class="detailLabelContent"  id="dskillsId"></span></td>
                            </td>
                        </tr>
                         <tr>
                            <td>
                                <td><label class="form-Label">Minimum Salary :</label></td>
                                <td>
                                    <label class="detailLabelContent" style=" " id="dminsal"></label></td>
                            </td>
                            <td>
                                <td> <label class="form-Label">Maximum Salary :</label></td>
                                <td> <label class="detailLabelContent" style=" " id="dmaxsal"></label> </td>
                            </td>
                        </tr>
                         <tr>
                            <td>
                                <td><label class="form-Label"># positions :</label>
                                   </td>
                                <td> <label class="detailLabelContent" style=" " id="dnoOfPositions"></label>  </td>
                            </td>
                            <td>
                                <td><label class="form-Label">Years Of Experience  :</label>
                                    </td>
                                <td> <label class="detailLabelContent" style=" " id="dyox"></label></td>
                            </td>
                        </tr>
                         <tr>
                            <td>
                                <td><label class="form-Label">Suggested Interviewer :</label>
                                    </td>
                                <td><label class="detailLabelContent" style=" " id="drec"></label>  </td>
                            </td>
                            <td>
                                <td> <label class="form-Label">Assigned HR  :</label>
                                    </td>
                                <td> <label class="detailLabelContent" style=" " id="dadminhr"></label></td>
                            </td>
                        </tr>
                         <tr>
                            <td>
                                <td>
                                    <label class="form-Label">Expiry Date :</label> 
                                </td>
                                <td>
                                     <label class="detailLabelContent" style=" " id="dexpiresOn"></label>
                                </td>
                            </td>
                            <td>
                                <td>  <label class="form-Label">Priority  :</label> </td>
                                <td> <label class="detailLabelContent" style=" " id="dpriority"></label></td>
                            </td>
                             
                        </tr>
                    </table>


                        <div id="" class="row" style="margin-top:10px;background-color:white;">
                            
                                <ul class="nav nav-tabs" style="background-color:none;font-size:13px">
                                    <li class="active"><a data-toggle="tab" style="color:grey" href="#ddiscription">Job Description</a></li>
                                    <li><a data-toggle="tab" style="color:grey" href="#dhistory">History</a></li>
                                </ul>
                                <div class="tab-content">
                                    <div id="ddiscription" class="tab-pane fade in active" style="margin-top:2%;">
                                    </div>
                                    <div id="dhistory" class="tab-pane fade table-responsive" style="height:100px;overflow-y:scroll;margin-top:2%;">

                                            <table id="dhistoryTable" style="font-size:12px;">
                                            </table>

                                            <p></p>
                                    </div>
                                </div>
                            
                        </div>

                    </div>

                </div>
            </div>
        </div>
        </div>
 




 